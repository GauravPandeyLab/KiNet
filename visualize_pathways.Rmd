```{r}
library(shiny)
library(visNetwork)
options(shiny.trace = TRUE)
```
# Pathways
##  {.sidebar data-width="200" .opening-page-text}

#### Kinase groups
```{r}
imageOutput('legend2',height="auto")
output$legend2 <- renderImage({
  list(src='img/kinase_families_legend2.png',width="100%")
},deleteFile=FALSE)
```

#### Modify 

```{r,cache=FALSE}
checkboxInput(inputId='toggleOneDegree2', "Include adjacent proteins.", value = FALSE)
checkboxInput(inputId='toggleDisconnected2', "Include disconnected proteins.", value = FALSE)
```

#### Layout 
```{r,cache=FALSE}
  selectizeInput('layout2',label=NULL,choices=names(layout_choices),selected="Default",multiple=FALSE)
```
#### Export
```{r, cache=FALSE}
  selectizeInput('download_choice2',label=NULL,choices=names(export_choices))
  filename2 <- reactive({export_choices[[input$download_choice2]]})
  (downloadButton('download2',"Download"))
  
  output$download2 <- downloadHandler(
    filename=function() {filename2()},
    content = function(file) {export_method(filename2(),g2(),file)}
  )
```


## Main Panel
#### Description {.opening-page-text}
This visualization shows a <b>curated pathway</b> from [KEGG](https://www.genome.jp/kegg/pathway.html) and its kinase-substrate interactions. 


#### Select a pathway
```{r, cache = FALSE}
selectizeInput(inputId='pathway',label=NULL,choices=all_pathways,selected="MAPK signaling pathway",options=list(maxOptions=300))
initialGeneList <- reactive({get_pathway_genes(input$pathway)})
```

### {}
```{r,cache=FALSE}
g2 <- reactive({get_pathway_graph(initialGeneList(),input$toggleOneDegree2,input$toggleDisconnected2)})
visNetworkOutput('network2')
output$network2 <- renderVisNetwork({
  vis_default(g2()) %>%
  visEvents(select="function(nodes){Shiny.onInputChange('selectNode2',nodes.nodes);}") %>%
  visEvents(doubleClick="function(nodes){Shiny.onInputChange('nextCenterNode',nodes.nodes)}") %>%
  visEvents(selectEdge = "function(edges) {Shiny.setInputValue('selectedEdges2', edges);}") %>%
  visIgraphLayout(layout=layout_choices[[input$layout2]])
   })

infoGene2 <- reactive({
  #if(req(input$selectNode2)) {NULL} else {get_gene_name(input$selectNode2)}
  if(is.null(input$selectNode2)) {NULL} else {get_gene_name(input$selectNode2)}
  })

infoEdge2 <- reactive({
    req(input$selectedEdges2)
    req(input$selectedEdges2$edges)
    req(g2())
    req(g2()$edges)
    edge_id <- input$selectedEdges2$edges
    e <- g2()$edges %>% filter(id == edge_id)
    req(nrow(e)==1)
    render_edge_info(e)
})

# infoEdge2 <- reactive({
#   req(input$selectedEdges2)
#   edge_id <- input$selectedEdges2$edges
#   req(edge_id)
#   e <- g2()$edges %>% filter(id == edge_id)
#     render_edge_info(e)
#   # if (length(input$selectedEdges2$edges)==1) {
#   #   edge_id <- input$selectedEdges2$edges
#   #   e <- g2()$edges %>% filter(id == edge_id)
#   #   paste(e)
#   #   #render_edge_info(e)
#   # } else {tags$p('')}
#   # if (!is.null(input$selectedEdges2) & length(input$selectedEdges2$edges)==1) {
#   #       edge_id <- input$selectedEdges2$edges
#   #       e <- g2()$edges %>% filter(id == edge_id)
#   #       #return(paste(e))
#   #       render_edge_info(e)
#   # } else {tags$p('')}
# })
```

##  {data-width="200" .opening-page-text}
#### Selected Interaction

```{r,cache=FALSE}
  renderUI({
    # req(input$selectedEdges2)
    # req(input$selectedEdges2$edges)
    # req(g2())
    # req(g2()$edges)
    # edge_id <- input$selectedEdges2$edges
    # #req(length(edge_id)==1)
    # e <- g2()$edges %>% filter(id == edge_id)
    # req(nrow(e)==1)
    # render_edge_info(e)
    #renderText(paste(nrow(e)))
    #renderTable(e)
    #req(length(e)>0)
    #if (lengths(e) == 0) {
    #  return(tagList(p("No elements selected.")))
    #} else {  tagList(paste(e)) }
    #render_edge_info(e)
    #e <- g2()$edges %>% filter(id == edge_id)
    #if (!is.null(e)) {render_edge_info(e)} else {tagList('')}
    
    infoEdge2()
    #render_edge_info(e)
    # if(req(input$selectedEdges2,input$selectedEdges2$edges) )
    #    {'Hello'} else {tags$p('')}
    #   #infoEdge2()
    })
```

#### Troubleshooting
<div class="options-text">
<p>Not laid out as expected? </p>
<ul> 
  <li> Try a different layout.</li>
  <li> Select/drag to manually move nodes.</li>
  <li> Use mouse to zoom/pan.</li>
</ul>
<p>Not seeing nodes or edges? </p>
<ul>
<li> Select "Include adjacent proteins" to expand the selected set using adjacent interactions. </li>
<li> Deselect "Exclude disconnected proteins" to also show all proteins in the set. </li>
<li> Try both for very small protein sets. </li>
</ul>
</div>